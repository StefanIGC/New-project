<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hai Rodica ‚ù§Ô∏è</title>
  <style>
    :root {
      --bg1: #2a0f1e;
      --bg2: #3a1630;
      --accent: #f472b6;
      --accent-2: #f9a8d4;
      --text: #fff7fb;
      --muted: #f3cde0;
      --card: rgba(255, 255, 255, 0.08);
      --ok: #f472b6;
      --bad: #fb7185;
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", system-ui, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% 10%, #5b1d47 0%, transparent 60%),
                  radial-gradient(1000px 800px at 90% 10%, #4a1b3c 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 32px 16px;
    }

    .app {
      width: min(1180px, 100%);
      display: grid;
      gap: 24px;
    }

    header {
      display: grid;
      gap: 8px;
    }

    .kicker {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 0.75rem;
      color: var(--accent-2);
    }

    h1 {
      font-family: "IBM Plex Serif", "Georgia", serif;
      font-weight: 600;
      margin: 0;
      font-size: clamp(2rem, 2vw + 1.6rem, 3rem);
    }

    .sub {
      margin: 0;
      color: var(--muted);
      max-width: 60ch;
      line-height: 1.5;
    }

    .panel {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: clamp(20px, 4vw, 32px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .chip {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--text);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .chip strong { color: inherit; }

    .question {
      font-size: 1.35rem;
      line-height: 1.4;
      margin: 16px 0 24px 0;
    }

    .question-media-wrap {
      margin-top: 14px;
    }

    .question-media {
      width: min(520px, 100%);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      background: rgba(255,255,255,0.05);
    }

    .question-media-list {
      display: grid;
      gap: 10px;
    }

    .qa-image {
      width: min(420px, 100%);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      margin: 8px 0 10px 0;
      display: block;
    }

    .answers {
      display: grid;
      gap: 12px;
    }

    .answer-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid transparent;
      border-radius: 14px;
      padding: 14px 16px;
      text-align: left;
      color: var(--text);
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.15s ease, border 0.15s ease, background 0.15s ease;
    }

    .answer-btn:hover {
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.2);
    }

    .answer-btn.correct {
      background: rgba(34, 197, 94, 0.38);
      border-color: rgba(34, 197, 94, 0.8);
    }

    .answer-btn.wrong {
      background: rgba(239, 68, 68, 0.35);
      border-color: rgba(239, 68, 68, 0.85);
    }

    .answer-btn.selected {
      border-color: rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.14);
    }

    .answer-btn.wrong.selected {
      background: rgba(239, 68, 68, 0.45);
      border-color: rgba(239, 68, 68, 0.95);
    }

    .answer-btn.correct.selected {
      background: rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.35);
    }

    .feedback {
      margin-top: 16px;
      min-height: 24px;
      font-size: 0.95rem;
    }

    .feedback.ok { color: var(--ok); }
    .feedback.bad { color: var(--bad); }

    .actions {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .menu-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: minmax(0, 1fr);
    }

    .field {
      display: grid;
      gap: 8px;
    }

    .field label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .field input[type="text"],
    .field input[type="url"] {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 0.95rem;
    }

    .dropdown {
      position: relative;
      width: 100%;
    }

    .dropdown-trigger {
      width: 100%;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 0.95rem;
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
    }

    .dropdown-trigger::after {
      content: "‚ñæ";
      font-size: 0.9rem;
      color: var(--muted);
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(255, 226, 240, 0.95), rgba(255, 199, 225, 0.95));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 5;
      max-height: 260px;
      overflow: auto;
      display: none;
    }

    .dropdown.open .dropdown-menu {
      display: block;
    }

    .dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 0.95rem;
      color: #3b0a26;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: rgba(242, 114, 182, 0.25);
    }

    .dropdown-item[aria-disabled="true"] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats-list {
      display: grid;
      gap: 10px;
      margin-top: 8px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.95rem;
    }

    .stat-item span {
      color: var(--muted);
      font-size: 0.85rem;
    }

    button.primary {
      background: var(--accent);
      color: #3b0a26;
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 20px rgba(242, 158, 56, 0.3);
    }

    button.primary:hover { transform: translateY(-2px); }

    button.ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 999px;
      padding: 12px 20px;
      cursor: pointer;
    }

    button.ghost.small {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .hidden { display: none; }

    .top-actions {
      display: flex;
      justify-content: flex-end;
    }

    .bottom-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .result {
      font-size: 1.2rem;
      line-height: 1.6;
      color: var(--muted);
    }

    .review-list {
      margin-top: 16px;
      display: grid;
      gap: 10px;
    }

    .review-item {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .review-item strong {
      color: var(--text);
    }

    .review-panel {
      display: grid;
      gap: 16px;
    }

    .review-list-container {
      max-height: 70vh;
      overflow: auto;
      display: grid;
      gap: 16px;
      padding-right: 4px;
    }

    .qa-item {
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .qa-item .question {
      margin: 0 0 8px 0;
      font-size: 1rem;
    }

    .qa-item .answer {
      color: var(--accent-2);
      font-size: 0.95rem;
    }

    .qa-options {
      display: grid;
      gap: 6px;
      margin: 8px 0 6px 0;
      padding: 0;
      list-style: none;
      font-size: 0.95rem;
    }

    .qa-option {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }

    .qa-option.correct {
      border-color: rgba(34, 197, 94, 0.6);
      background: rgba(34, 197, 94, 0.18);
      color: #d9fbe2;
    }

    .answer-badge {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #c8facc;
      margin-left: 8px;
      vertical-align: middle;
    }

    .progress {
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      overflow: hidden;
      margin-top: 12px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width 0.25s ease;
    }

    .score {
      font-size: clamp(2.4rem, 2vw + 1.6rem, 3.2rem);
      color: var(--accent-2);
      font-weight: 600;
      margin: 12px 0 0 0;
    }

    @media (max-width: 640px) {
      .stats { flex-direction: column; align-items: flex-start; }
      .question { font-size: 1.2rem; }
      .stats button.ghost.small { align-self: flex-start; }
      .stats.quiz-stats { flex-direction: row; align-items: center; }
      .menu-grid { gap: 24px; }
      .panel { padding: 20px; }
      .actions { flex-direction: column; align-items: stretch; }
      button.primary, button.ghost { width: 100%; justify-content: center; }
      .review-list-container { max-height: 75vh; padding-right: 0; }
      .qa-item { padding: 14px; }
      #quiz-panel .stats { position: sticky; top: 0; z-index: 2; background: rgba(255, 230, 242, 0.6); backdrop-filter: blur(8px); padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
      #stats-panel .stats { gap: 10px; }
      #stats-panel .actions { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header id="app-header">
      <h1>Hai Rodica ‚ù§Ô∏è</h1>
      <p class="sub">Testele sunt pentru tine. Alege un test »ôi √Æncepe ‚Äî fiecare rƒÉspuns e un pas √Ænainte. E»ôti foarte bravo! üíñ</p>
    </header>

    <section class="panel" id="menu-panel">
      <div class="stats">
        <div class="chip"><strong id="menu-q-count">10</strong> √ÆntrebƒÉri</div>
      </div>
      <div class="menu-grid">
        <div>
          <div class="field" style="margin-top:16px;">
            <label for="test-select">Test disponibil</label>
            <div class="dropdown" id="test-dropdown">
              <button class="dropdown-trigger" id="test-trigger" type="button">Alege un test</button>
              <div class="dropdown-menu" id="test-menu" role="listbox"></div>
            </div>
          </div>
          <div class="field" style="margin-top:12px;">
            <label for="limit-select">NumƒÉr √ÆntrebƒÉri √Æn test</label>
            <div class="dropdown" id="limit-dropdown">
              <button class="dropdown-trigger" id="limit-trigger" type="button">20</button>
              <div class="dropdown-menu" id="limit-menu" role="listbox"></div>
            </div>
          </div>
          <div class="actions" style="justify-content:center;">
            <button class="ghost" id="view-stats-btn">Vezi statistici</button>
            <button class="ghost" id="view-questions-btn">Vezi √ÆntrebƒÉrile</button>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="start-btn">√éncepe testul</button>
      </div>
    </section>

    <section class="panel hidden" id="quiz-panel">
      <div class="bottom-actions hidden" id="abandon-wrap">
        <button class="ghost" id="abandon-btn">AbandoneazƒÉ</button>
      </div>
      <div class="stats quiz-stats">
        <div class="chip">√éntrebarea <strong id="q-index">1</strong> / <span id="q-total">10</span></div>
        <div class="chip">Scor curent: <strong id="score">0</strong></div>
      </div>
      <div class="progress" aria-hidden="true">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <div class="sub" id="multi-hint" style="margin-top:12px; display:none;">SelecteazƒÉ toate rƒÉspunsurile corecte.</div>
      <div class="question-media-wrap">
        <div id="question-images" class="question-media-list"></div>
      </div>
      <div class="question" id="question-text"></div>
      <div class="answers" id="answers"></div>
      <div class="feedback" id="feedback"></div>
      <div class="actions">
        <button class="primary hidden" id="next-btn">UrmƒÉtoarea √Æntrebare</button>
        <button class="primary hidden" id="confirm-btn">ConfirmƒÉ rƒÉspunsul</button>
      </div>
    </section>

    <section class="panel hidden" id="result-panel">
      <h2>Rezultat final üíó</h2>
      <p class="result">Ai rƒÉspuns la toate √ÆntrebƒÉrile.</p>
      <div class="score" id="final-score"></div>
      <p class="result" id="final-message"></p>
      <div class="review-list" id="review-list"></div>
      <div class="actions">
        <button class="primary" id="menu-btn">√énapoi la meniu</button>
      </div>
    </section>

    <section class="panel hidden" id="qa-panel">
      <div class="review-panel">
        <div class="stats">
          <div class="chip" id="qa-title">√éntrebƒÉri</div>
          <button class="ghost small" id="qa-back-btn">√énapoi la meniu</button>
        </div>
        <div class="review-list-container" id="qa-body"></div>
      </div>
    </section>

    <section class="panel hidden" id="stats-panel">
      <div class="review-panel">
        <div class="stats">
          <div class="chip" id="stats-title">Statistici</div>
          <div class="actions" style="margin-top:0;">
            <button class="ghost small" id="reset-stats-btn">ReseteazƒÉ statistica</button>
            <button class="ghost small" id="stats-back-btn">√énapoi la meniu</button>
          </div>
        </div>
        <div class="review-list-container" id="stats-body"></div>
      </div>
    </section>
  </div>

  <script>
    const testsIndexUrl = "tests/tests.json";
    let testsIndex = [];
    const testsById = new Map();

    const menuPanel = document.getElementById("menu-panel");
    const quizPanel = document.getElementById("quiz-panel");
    const resultPanel = document.getElementById("result-panel");
    const appHeader = document.getElementById("app-header");

    const qIndexEl = document.getElementById("q-index");
    const qTotalEl = document.getElementById("q-total");
    const scoreEl = document.getElementById("score");
    const progressBarEl = document.getElementById("progress-bar");
    const questionText = document.getElementById("question-text");
    const questionImages = document.getElementById("question-images");
    const answersEl = document.getElementById("answers");
    const feedbackEl = document.getElementById("feedback");
    const nextBtn = document.getElementById("next-btn");
    const confirmBtn = document.getElementById("confirm-btn");
    const multiHintEl = document.getElementById("multi-hint");
    const abandonWrap = document.getElementById("abandon-wrap");
    const abandonBtn = document.getElementById("abandon-btn");
    const finalScoreEl = document.getElementById("final-score");
    const finalMessageEl = document.getElementById("final-message");
    const reviewListEl = document.getElementById("review-list");

    const testDropdown = document.getElementById("test-dropdown");
    const testTrigger = document.getElementById("test-trigger");
    const testMenu = document.getElementById("test-menu");
    const limitDropdown = document.getElementById("limit-dropdown");
    const limitTrigger = document.getElementById("limit-trigger");
    const limitMenu = document.getElementById("limit-menu");
    const menuCountEl = document.getElementById("menu-q-count");
    const viewStatsBtn = document.getElementById("view-stats-btn");
    const viewQuestionsBtn = document.getElementById("view-questions-btn");
    const qaBody = document.getElementById("qa-body");
    const qaTitle = document.getElementById("qa-title");
    const qaPanel = document.getElementById("qa-panel");
    const qaBackBtn = document.getElementById("qa-back-btn");
    const statsPanel = document.getElementById("stats-panel");
    const statsBody = document.getElementById("stats-body");
    const statsTitle = document.getElementById("stats-title");
    const statsBackBtn = document.getElementById("stats-back-btn");

    let quizQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let answered = false;
    let activeTest = null;
    let activeTestMeta = null;
    let stats = [];
    let storedTestId = null;
    const allowedLimits = [10, 20, 50, 100, "toate"];
    let questionLimit = 20;
    let selectedIndices = new Set();
    let wrongAnswers = [];
    const encouragements = [
      "Rodica, e»ôti foarte bravo! üíñ »òtefan te iube»ôte.",
      "Iubu, e»ôti minunatƒÉ! üå∏ »òtefan te iube»ôte.",
      "Iubirea mea, ai fƒÉcut super! ‚ú®",
      "Rodica, z√¢mbetul tƒÉu e magie! üòä",
      "E»ôti at√¢t de specialƒÉ! üí´",
      "Te iubesc mult, iubi! ‚ù§Ô∏è",
      "Ai o inimƒÉ frumoasƒÉ, Rodica! üíó",
      "Bravo, iubirica mea! ü´∂",
      "E»ôti caldƒÉ »ôi bunƒÉ! ü§ó",
      "E»ôti foarte, foarte bravo! üå∑",
      "Ai fƒÉcut minunat! üíñ",
      "»òtefan e m√¢ndru de tine! ü•∞"
    ];

    const endMessages = [
      "Excelent, iubi! E»ôti super »ôi foarte bravo! üíñ",
      "Ai fost minunatƒÉ, Rodica! Te iubesc mult! ‚ù§Ô∏è",
      "Ce rezultat frumos! Z√¢mbet pentru iubu! üòä",
      "Ai strƒÉlucit! ‚ú® Rodica e cea mai bravo!",
      "MƒÉ topesc de drag! üíû Ai fƒÉcut grozav!",
      "Superb, iubi! √émbrƒÉ»õi»ôƒÉri mari! ü§ó",
      "Ai fost fantasticƒÉ! üå∏",
      "FelicitƒÉri, iubirea mea! ü´∂",
      "√éncƒÉ un pas frumos, iubi! üíó",
      "E»ôti minunea mea! üí´"
    ];

    function shuffle(array) {
      return array
        .map(value => ({ value, sort: Math.random() }))
        .sort((a, b) => a.sort - b.sort)
        .map(({ value }) => value);
    }

    function pickEncouragement() {
      return encouragements[Math.floor(Math.random() * encouragements.length)];
    }

    function pickEndMessage() {
      return endMessages[Math.floor(Math.random() * endMessages.length)];
    }

    function getCorrectIndices(question) {
      if (Array.isArray(question.correct)) return question.correct.slice();
      if (typeof question.correct === "number") return [question.correct];
      return [];
    }

    async function loadTestsIndex() {
      const res = await fetch(testsIndexUrl, { cache: "no-store" });
      if (!res.ok) throw new Error("Nu pot √ÆncƒÉrca lista de teste.");
      testsIndex = await res.json();
      const totalPool = testsIndex.reduce((sum, t) => sum + (t.count || 0), 0);
      testsIndex.unshift({
        id: "simulare-nationala",
        name: "Test National Simulare",
        file: null,
        count: totalPool
      });
    }

    async function loadTestById(id) {
      if (testsById.has(id)) return testsById.get(id);
      const meta = testsIndex.find(test => test.id === id);
      if (!meta) return null;
      if (!meta.file) return null;
      const res = await fetch(`tests/${meta.file}`, { cache: "no-store" });
      if (!res.ok) throw new Error("Nu pot √ÆncƒÉrca testul selectat.");
      const data = await res.json();
      testsById.set(id, data);
      return data;
    }

    async function loadSimularePool() {
      const pool = [];
      for (const test of testsIndex) {
        if (!test.file) continue;
        const data = await loadTestById(test.id);
        if (data && Array.isArray(data.questions)) {
          pool.push(...data.questions);
        }
      }
      return pool;
    }

    async function setActiveTest(id) {
      if (!id) return;
      const meta = testsIndex.find(test => test.id === id);
      if (!meta) return;
      activeTestMeta = meta;
      localStorage.setItem("med-quiz-test", meta.id);
      menuCountEl.textContent = meta.count;
      renderStats();
      renderLimitSelect();
      if (!meta.file) {
        const pool = await loadSimularePool();
        activeTest = { id: meta.id, name: meta.name, questions: pool };
      } else {
        activeTest = await loadTestById(meta.id);
      }
    }

    function loadState() {
      try {
        const storedStats = JSON.parse(localStorage.getItem("med-quiz-stats"));
        const storedTest = localStorage.getItem("med-quiz-test");
        const storedLimit = localStorage.getItem("med-quiz-limit");
        if (Array.isArray(storedStats)) stats = storedStats;
        if (storedTest) storedTestId = storedTest;
        if (storedLimit) questionLimit = storedLimit === "toate" ? "toate" : Number(storedLimit);
      } catch {
        stats = [];
      }
    }

    function saveStats() {
      localStorage.setItem("med-quiz-stats", JSON.stringify(stats));
    }

    function renderStats() {
      if (!activeTestMeta) return;
      // no-op in menu now; stats are shown in the stats panel
    }

    function showMenu() {
      quizPanel.classList.add("hidden");
      resultPanel.classList.add("hidden");
      abandonWrap.classList.add("hidden");
      qaPanel.classList.add("hidden");
      statsPanel.classList.add("hidden");
      appHeader.classList.remove("hidden");
      menuPanel.classList.remove("hidden");
      renderStats();
      renderTestSelect();
    }

    async function startQuiz() {
      if (!activeTest) {
        await setActiveTest(activeTestMeta?.id || testsIndex[0]?.id);
      }
      if (!activeTest) return;
      const now = new Date();
      const hour = now.getHours();
      const minute = now.getMinutes();
      const isLate = (hour === 23 && minute >= 30) || hour < 6;
      if (isLate) {
        alert("Rodica, iubire, e vremea de culcare ‚ù§Ô∏è");
      }
      const total = activeTest.questions.length;
      const limit = questionLimit === "toate" ? total : Math.min(questionLimit, total);
      quizQuestions = shuffle(activeTest.questions).slice(0, limit);
      currentIndex = 0;
      score = 0;
      answered = false;
      wrongAnswers = [];
      scoreEl.textContent = score;
      qTotalEl.textContent = quizQuestions.length;
      menuPanel.classList.add("hidden");
      appHeader.classList.add("hidden");
      resultPanel.classList.add("hidden");
      abandonWrap.classList.remove("hidden");
      quizPanel.classList.remove("hidden");
      renderQuestion();
    }

    function renderQuestion() {
      const current = quizQuestions[currentIndex];
      const correctIndices = getCorrectIndices(current);
      const isMulti = correctIndices.length > 1;
      qIndexEl.textContent = currentIndex + 1;
      if (progressBarEl) {
        const percent = ((currentIndex + 1) / Math.max(quizQuestions.length, 1)) * 100;
        progressBarEl.style.width = `${percent}%`;
      }
      questionText.textContent = current.text;
      const imgList = Array.isArray(current.images) && current.images.length
        ? current.images
        : (current.image ? [current.image] : []);
      questionImages.innerHTML = "";
      imgList.forEach((src, i) => {
        const img = document.createElement("img");
        img.className = "question-media";
        img.loading = "lazy";
        img.alt = `Imagine √Æntrebare ${currentIndex + 1}${imgList.length > 1 ? ` (${i + 1})` : ""}`;
        img.src = src;
        questionImages.appendChild(img);
      });
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      nextBtn.classList.add("hidden");
      confirmBtn.classList.add("hidden");
      multiHintEl.style.display = isMulti ? "block" : "none";
      answered = false;
      selectedIndices = new Set();

      answersEl.innerHTML = "";
      current.options.forEach((option, index) => {
        const btn = document.createElement("button");
        btn.className = "answer-btn";
        btn.textContent = option;
        btn.addEventListener("click", () => handleAnswer(btn, index, isMulti));
        answersEl.appendChild(btn);
      });
      if (isMulti) confirmBtn.classList.remove("hidden");
    }

    function handleAnswer(button, index, isMulti) {
      if (answered) return;
      const current = quizQuestions[currentIndex];
      const correctIndices = getCorrectIndices(current);
      const buttons = Array.from(answersEl.children);

      if (isMulti) {
        if (selectedIndices.has(index)) {
          selectedIndices.delete(index);
          button.classList.remove("selected");
        } else {
          selectedIndices.add(index);
          button.classList.add("selected");
        }
        return;
      }

      answered = true;
      buttons.forEach((btn, idx) => {
        if (correctIndices.includes(idx)) {
          btn.classList.add("correct");
        }
      });

      if (correctIndices.includes(index)) {
        score += 1;
        scoreEl.textContent = score;
        feedbackEl.textContent = "Corect!";
        feedbackEl.classList.add("ok");
        nextBtn.classList.remove("hidden");
      } else {
        button.classList.add("wrong");
        if (navigator.vibrate) navigator.vibrate(50);
        const correctText = correctIndices.map(i => current.options[i]).join(", ");
        feedbackEl.textContent = `Gre»ôit. RƒÉspuns corect: ${correctText}.`;
        feedbackEl.classList.add("bad");
        nextBtn.classList.remove("hidden");
        wrongAnswers.push({
          question: current.text,
          correct: correctText
        });
      }
    }

    function confirmMultiAnswer() {
      if (answered) return;
      const current = quizQuestions[currentIndex];
      const correctIndices = getCorrectIndices(current).sort();
      const selected = Array.from(selectedIndices).sort();
      const buttons = Array.from(answersEl.children);
      answered = true;
      confirmBtn.classList.add("hidden");

      buttons.forEach((btn, idx) => {
        const isCorrect = correctIndices.includes(idx);
        const isSelected = selectedIndices.has(idx);
        if (isCorrect) {
          btn.classList.add("correct");
          if (isSelected) btn.classList.add("selected");
        }
        if (isSelected && !isCorrect) {
          btn.classList.add("wrong");
        }
      });

      const isCorrect = correctIndices.length === selected.length &&
        correctIndices.every((value, idx) => value === selected[idx]);

      if (isCorrect) {
        score += 1;
        scoreEl.textContent = score;
        feedbackEl.textContent = "Corect!";
        feedbackEl.classList.add("ok");
        nextBtn.classList.remove("hidden");
      } else {
        if (navigator.vibrate) navigator.vibrate(50);
        const correctText = correctIndices.map(i => current.options[i]).join(", ");
        feedbackEl.textContent = `Gre»ôit. RƒÉspuns corect: ${correctText}.`;
        feedbackEl.classList.add("bad");
        nextBtn.classList.remove("hidden");
        wrongAnswers.push({
          question: current.text,
          correct: correctText
        });
      }
    }

    function goNext() {
      if (currentIndex < quizQuestions.length - 1) {
        currentIndex += 1;
        renderQuestion();
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else {
        showResult();
      }
    }

    function showResult() {
      quizPanel.classList.add("hidden");
      abandonWrap.classList.add("hidden");
      resultPanel.classList.remove("hidden");
      finalScoreEl.textContent = `Nota: ${score} / ${quizQuestions.length}`;
      const percent = Math.round((score / quizQuestions.length) * 100);
      if (percent >= 90) {
        finalMessageEl.textContent = pickEndMessage();
      } else if (percent >= 70) {
        finalMessageEl.textContent = pickEndMessage();
      } else if (percent >= 50) {
        finalMessageEl.textContent = pickEndMessage();
      } else {
        finalMessageEl.textContent = "Nu te descuraja, iubi. »òtefan te iube»ôte mult »ôi mereu e l√¢ngƒÉ tine. üíó";
      }
      addStatEntry();
      renderReview();
    }

    function renderReview() {
      reviewListEl.innerHTML = "";
      if (wrongAnswers.length === 0) {
        const item = document.createElement("div");
        item.className = "review-item";
        item.textContent = "Perfect! Nu ai gre»ôit nicio √Æntrebare. üíñ";
        reviewListEl.appendChild(item);
        return;
      }
      wrongAnswers.forEach((entry, idx) => {
        const item = document.createElement("div");
        item.className = "review-item";
        item.innerHTML = `<strong>Gre»ôit ${idx + 1}:</strong> ${entry.question}<br><strong>RƒÉspuns corect:</strong> ${entry.correct}`;
        reviewListEl.appendChild(item);
      });
    }

    function addStatEntry() {
      const now = new Date();
      const entry = {
        score,
        total: quizQuestions.length,
        testId: activeTest.id,
        test: activeTest.name,
        date: now.toLocaleDateString("ro-RO", {
          year: "numeric",
          month: "short",
          day: "2-digit"
        }),
        time: now.toLocaleTimeString("ro-RO", {
          hour: "2-digit",
          minute: "2-digit"
        })
      };
      stats.push(entry);
      saveStats();
    }

    function renderTestSelect() {
      testMenu.innerHTML = "";
      testsIndex.forEach(test => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = `${test.name} (${test.count} √ÆntrebƒÉri)`;
        item.dataset.value = test.id;
        item.addEventListener("click", async () => {
          await setActiveTest(test.id);
          closeDropdowns();
          testTrigger.textContent = `${test.name} (${test.count} √ÆntrebƒÉri)`;
        });
        testMenu.appendChild(item);
      });
      if (activeTestMeta) {
        menuCountEl.textContent = activeTestMeta.count;
        testTrigger.textContent = `${activeTestMeta.name} (${activeTestMeta.count} √ÆntrebƒÉri)`;
      }
    }

    function renderQuestionsModal() {
      if (!activeTest) return;
      qaTitle.textContent = `${activeTest.name} ‚Äî √ÆntrebƒÉri »ôi rƒÉspunsuri`;
      qaBody.innerHTML = "";
      activeTest.questions.forEach((q, idx) => {
        const correctIndices = getCorrectIndices(q);
        const correctText = correctIndices.map(i => q.options[i]).join(", ");
        const item = document.createElement("div");
        item.className = "qa-item";
        const optionsHtml = q.options.map((opt, i) => {
          const cls = correctIndices.includes(i) ? "qa-option correct" : "qa-option";
          return `<li class="${cls}">${opt}</li>`;
        }).join("");
        const qaImgs = Array.isArray(q.images) && q.images.length ? q.images : (q.image ? [q.image] : []);
        const imageHtml = qaImgs.map((src, i) => `<img class="qa-image" src="${src}" alt="Imagine √Æntrebare ${idx + 1}${qaImgs.length > 1 ? ` (${i + 1})` : ""}" loading="lazy" />`).join("");
        item.innerHTML = `<div class=\"question\"><strong>${idx + 1}.</strong> ${q.text}</div>
          ${imageHtml}
          <ul class=\"qa-options\">${optionsHtml}</ul>
          <div class=\"answer\">RƒÉspuns corect: ${correctText}</div>`;
        qaBody.appendChild(item);
      });
      menuPanel.classList.add("hidden");
      qaPanel.classList.remove("hidden");
    }

    function closeQuestionsPanel() {
      qaPanel.classList.add("hidden");
      menuPanel.classList.remove("hidden");
      appHeader.classList.remove("hidden");
    }

    function renderStatsPanel() {
      if (!activeTestMeta) return;
      const filtered = stats.filter(entry => entry.testId === activeTestMeta.id);
      statsTitle.textContent = `Statistici ‚Äî ${activeTestMeta.name}`;
      statsBody.innerHTML = "";

      const totalAttempts = filtered.length;
      const bestScore = totalAttempts ? Math.max(...filtered.map(e => e.score / e.total)) : 0;
      const avgScore = totalAttempts ? filtered.reduce((sum, e) => sum + (e.score / e.total), 0) / totalAttempts : 0;

      const summary = document.createElement("div");
      summary.className = "qa-item";
      summary.innerHTML = `<div class=\"question\"><strong>Rezumat</strong></div>
        <div class=\"answer\">√éncercƒÉri: ${totalAttempts}</div>
        <div class=\"answer\">Media: ${(avgScore * 100).toFixed(1)}%</div>
        <div class=\"answer\">Cea mai bunƒÉ notƒÉ: ${(bestScore * 100).toFixed(1)}%</div>`;
      statsBody.appendChild(summary);

      if (totalAttempts === 0) {
        const empty = document.createElement("div");
        empty.className = "qa-item";
        empty.innerHTML = "<div class=\"question\">Nu existƒÉ note salvate √ÆncƒÉ pentru acest test.</div>";
        statsBody.appendChild(empty);
      } else {
        const last = filtered.slice().reverse().slice(0, 10);
        last.forEach((entry, idx) => {
          const item = document.createElement("div");
          item.className = "qa-item";
          item.innerHTML = `<div class=\"question\"><strong>√éncercare ${idx + 1}</strong> ‚Äî ${entry.date} ${entry.time || ""}</div>
            <div class=\"answer\">Nota: ${entry.score} / ${entry.total} (${Math.round((entry.score / entry.total) * 100)}%)</div>`;
          statsBody.appendChild(item);
        });
      }

      menuPanel.classList.add("hidden");
      statsPanel.classList.remove("hidden");
    }

    function closeStatsPanel() {
      statsPanel.classList.add("hidden");
      menuPanel.classList.remove("hidden");
      appHeader.classList.remove("hidden");
    }

    function renderLimitSelect() {
      const total = activeTestMeta ? activeTestMeta.count : 0;
      limitMenu.innerHTML = "";
      allowedLimits.forEach(value => {
        const isAll = value === "toate";
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.dataset.value = String(value);
        item.textContent = isAll ? "Toate" : `${value}`;
        if (!isAll && total && value > total) {
          item.setAttribute("aria-disabled", "true");
        } else {
          item.addEventListener("click", () => {
            questionLimit = value === "toate" ? "toate" : Number(value);
            localStorage.setItem("med-quiz-limit", String(value));
            limitTrigger.textContent = isAll ? "Toate" : `${value}`;
            closeDropdowns();
          });
        }
        limitMenu.appendChild(item);
      });
      limitTrigger.textContent = questionLimit === "toate" ? "Toate" : `${questionLimit}`;
    }

    function closeDropdowns() {
      testDropdown.classList.remove("open");
      limitDropdown.classList.remove("open");
    }

    document.getElementById("reset-stats-btn").addEventListener("click", () => {
      stats = [];
      saveStats();
      renderStatsPanel();
    });

    testTrigger.addEventListener("click", () => {
      const open = testDropdown.classList.toggle("open");
      if (open) limitDropdown.classList.remove("open");
    });

    limitTrigger.addEventListener("click", () => {
      const open = limitDropdown.classList.toggle("open");
      if (open) testDropdown.classList.remove("open");
    });

    document.addEventListener("click", (event) => {
      if (!testDropdown.contains(event.target) && !limitDropdown.contains(event.target)) {
        closeDropdowns();
      }
    });

    document.getElementById("start-btn").addEventListener("click", () => {
      startQuiz();
    });
    document.getElementById("next-btn").addEventListener("click", goNext);
    confirmBtn.addEventListener("click", confirmMultiAnswer);
    document.getElementById("menu-btn").addEventListener("click", showMenu);
    viewQuestionsBtn.addEventListener("click", async () => {
      if (!activeTest) {
        await setActiveTest(activeTestMeta?.id || testsIndex[0]?.id);
      }
      renderQuestionsModal();
    });
    qaBackBtn.addEventListener("click", closeQuestionsPanel);
    viewStatsBtn.addEventListener("click", () => {
      renderStatsPanel();
    });
    statsBackBtn.addEventListener("click", closeStatsPanel);

    abandonBtn.addEventListener("click", () => {
      const ok = confirm("Vrei sƒÉ abandonezi testul? Progresul curent se va pierde.");
      if (ok) showMenu();
    });

    async function init() {
      loadState();
      try {
        await loadTestsIndex();
        const initialId = storedTestId || testsIndex[0]?.id;
        await setActiveTest(initialId);
        renderLimitSelect();
        showMenu();
      } catch (err) {
        console.error(err);
        alert("Nu s-au putut √ÆncƒÉrca testele. VerificƒÉ dacƒÉ fi»ôierele existƒÉ.");
      }
    }

    init();
  </script>
</body>
</html>
